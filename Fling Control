-- LocalScript in StarterPlayer > StarterPlayerScripts
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local cam = Workspace.CurrentCamera

-- UI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FlingBounceGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Toggle Button (top right)
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 120, 0, 40)
toggleButton.Position = UDim2.new(1, -130, 0, 10) -- top right
toggleButton.AnchorPoint = Vector2.new(0, 0)
toggleButton.BackgroundColor3 = Color3.fromRGB(30, 120, 30)
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.Text = "Bounce: ON"
toggleButton.Parent = screenGui

-- Fling indicator (circle top left)
local flingIndicator = Instance.new("Frame")
flingIndicator.Size = UDim2.new(0, 30, 0, 30)
flingIndicator.Position = UDim2.new(0, 10, 0, 10) -- top left
flingIndicator.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
flingIndicator.BorderSizePixel = 0
flingIndicator.Parent = screenGui

-- Make it circular
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(1, 0)
corner.Parent = flingIndicator

local systemEnabled = true
toggleButton.MouseButton1Click:Connect(function()
	systemEnabled = not systemEnabled
	toggleButton.Text = systemEnabled and "Bounce: ON" or "Bounce: OFF"
	toggleButton.BackgroundColor3 = systemEnabled and Color3.fromRGB(30, 120, 30) or Color3.fromRGB(120, 30, 30)
end)

-- Character getter
local function getCharacter()
	local char = player.Character or player.CharacterAdded:Wait()
	local humanoid = char:WaitForChild("Humanoid")
	local root = char:WaitForChild("HumanoidRootPart")
	return humanoid, root, char
end

local humanoid, root, char = getCharacter()

-- Settings
local flingVelocityThreshold = 25
local sittingSpeedThreshold = 18
local bounceMultiplier = 1.2
local ragdollStates = {
	Enum.HumanoidStateType.Physics,
	Enum.HumanoidStateType.FallingDown,
	Enum.HumanoidStateType.Ragdoll,
}

local ragdolled = false
local flinging = false
local sitting = false

-- Detect ragdoll states
humanoid.StateChanged:Connect(function(_, new)
	ragdolled = false
	for _, s in ipairs(ragdollStates) do
		if new == s then
			ragdolled = true
			break
		end
	end
end)

-- Detect sitting
humanoid:GetPropertyChangedSignal("Sit"):Connect(function()
	sitting = humanoid.Sit
end)

-- Determine if fling logic should be active
local function shouldFling()
	if not systemEnabled or not root then return false end
	local vel = root.Velocity
	local horizontalSpeed = Vector3.new(vel.X, 0, vel.Z).Magnitude

	if ragdolled then return true end
	if horizontalSpeed > flingVelocityThreshold then return true end
	if sitting and horizontalSpeed > sittingSpeedThreshold then return true end

	return false
end

-- Redirect fling momentum instantly
RunService.Heartbeat:Connect(function()
	if root and shouldFling() then
		flinging = true
		flingIndicator.BackgroundColor3 = Color3.fromRGB(0, 200, 0)

		local vel = root.Velocity
		local horizontalSpeed = Vector3.new(vel.X, 0, vel.Z).Magnitude

		local look = cam.CFrame.LookVector
		local flatLook = Vector3.new(look.X, 0, look.Z)

		if flatLook.Magnitude > 0 then
			flatLook = flatLook.Unit
			local newVel = flatLook * horizontalSpeed
			root.Velocity = Vector3.new(newVel.X, vel.Y, newVel.Z)
		end
	else
		flinging = false
		flingIndicator.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
	end
end)

-- Bounce with velocity increase
local function setupBounce(char, rootPart)
	for _, part in ipairs(char:GetDescendants()) do
		if part:IsA("BasePart") and part ~= rootPart then
			part.Touched:Connect(function(hit)
				if systemEnabled and flinging and hit.CanCollide and not hit:IsDescendantOf(char) then
					local vel = rootPart.Velocity
					if vel.Y < -5 then
						-- Raycast to get surface normal
						local rayOrigin = rootPart.Position
						local rayDir = Vector3.new(0, -5, 0)
						local raycastParams = RaycastParams.new()
						raycastParams.FilterDescendantsInstances = {char}
						raycastParams.FilterType = Enum.RaycastFilterType.Exclude

						local result = Workspace:Raycast(rayOrigin, rayDir, raycastParams)
						if result then
							local normal = result.Normal
							local reflection = vel - 2 * vel:Dot(normal) * normal
							rootPart.Velocity = reflection * bounceMultiplier
						else
							rootPart.Velocity = Vector3.new(vel.X, math.abs(vel.Y) * bounceMultiplier, vel.Z)
						end
					end
				end
			end)
		end
	end
end

setupBounce(char, root)

-- Reapply when respawning
player.CharacterAdded:Connect(function(newChar)
	humanoid, root, char = getCharacter()
	setupBounce(char, root)
end)
